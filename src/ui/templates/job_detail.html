{% extends "base.html" %}
{% block content %}
<h1>Job: {{ job_folder }}</h1>
<p><strong>Phase:</strong> {{ phase }}</p>

<div class="grid">
  <div class="panel">
    <h2>Job YAML</h2>
    <pre class="code">{{ job | tojson(indent=2) }}</pre>

    <h3>Run Events</h3>
    <form method="post" action="{{ url_for('run_job_event', phase=phase, job_folder=job_folder) }}">
      <label>Mode</label>
      <select name="mode">
        <option value="llm">llm</option>
        <option value="static">static</option>
      </select>
      <label style="display:block;margin-top:6px;">
        <input type="checkbox" name="verbatim" /> Verbatim Mode (safe)
      </label>
      <label>Event</label>
      <select name="event">
        <option value="get_url">get_url</option>
        <option value="batch_gen_data_truthful">batch_gen_data_truthful</option>
        <option value="gen_truthful_summary">gen_truthful_summary</option>
        <option value="gen_truthful_skills">gen_truthful_skills</option>
        <option value="gen_truthful_highlights">gen_truthful_highlights</option>
        <option value="gen_truthful_experience">gen_truthful_experience</option>
        <option value="batch_gen_docs">batch_gen_docs</option>
        <option value="move_errored">move_errored</option>
        <option value="get_gmail_linkedin">get_gmail_linkedin</option>
      </select>
      <button type="submit">Run</button>
    </form>

    <h3>Move Phase</h3>
    <form method="post" action="{{ url_for('move_job', phase=phase, job_folder=job_folder) }}">
      <select name="target_phase">
        <option>1_Queued</option>
        <option>2_Data Generated</option>
        <option>3_Docs Generated</option>
        <option>4_Applied</option>
        <option>5_FollowUp</option>
        <option>6_Interviewing</option>
        <option>7_Negotiating</option>
        <option>8_Accepted</option>
        <option>Skipped</option>
        <option>Expired</option>
        <option>Errored</option>
      </select>
      <button type="submit">Move</button>
    </form>
  </div>

  <div class="panel">
    <h2>Subcontent Files</h2>
    {% for k,v in sub.items() %}
      <details>
        <summary>{{ k }}</summary>
        <pre class="code">{{ v }}</pre>
      </details>
    {% else %}
      <div class="empty">No subcontent yet. Run batch_gen_data_truthful.</div>
    {% endfor %}

    {% if invalid and invalid|length > 0 %}
      <h2>Validation Failures</h2>
      <p class="muted">
        This section failed twice: first attempt + automatic repair attempt.<br/>
        Next steps:
        (1) Re-run in <strong>Verbatim Mode</strong>,
        (2) Manually edit the invalid YAML file in the job folder and re-run,
        (3) Move the job to <strong>Errored</strong>.
      </p>

      {% for k,v in invalid.items() %}
        <details open>
          <summary>{{ k }} (invalid)</summary>
          <div style="margin:6px 0;">
            <form method="post" action="{{ url_for('run_job_event', phase=phase, job_folder=job_folder) }}" style="display:inline;">
              <input type="hidden" name="mode" value="llm"/>
              <input type="hidden" name="event" value="gen_truthful_{{k}}"/>
              <input type="hidden" name="verbatim" value="on"/>
              <button type="submit">Re-run {{k}} in Verbatim Mode</button>
            </form>
            <form method="post" action="{{ url_for('run_job_event', phase=phase, job_folder=job_folder) }}" style="display:inline;margin-left:6px;">
              <input type="hidden" name="mode" value="llm"/>
              <input type="hidden" name="event" value="move_errored"/>
              <button type="submit">Move job to Errored</button>
            </form>
          </div>
          <pre class="code">{{ v }}</pre>
        </details>
      {% endfor %}
    {% endif %}

    <h2>Artifacts</h2>
    <ul>
      <li>job.html: {{ 'yes' if artifacts.job_html_exists else 'no' }}</li>
      <li>resume.html: {{ 'yes' if artifacts.resume_html_exists else 'no' }}</li>
      <li>resume.pdf: {{ 'yes' if artifacts.resume_pdf_exists else 'no' }}</li>
      <li>coverletter.html: {{ 'yes' if artifacts.coverletter_html_exists else 'no' }}</li>
      <li>coverletter.pdf: {{ 'yes' if artifacts.coverletter_pdf_exists else 'no' }}</li>
    </ul>
  </div>
</div>
{% endblock %}
